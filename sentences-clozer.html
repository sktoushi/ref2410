<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fill in the Blanks Exercise</title>
    <!-- Bootstrap CSS CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-wyr6gYltfxRL6C8P+lJy+/0wKdF3B1vBv47mVJ4oZ3uMS9I2akl8tt5kEoqV8jEc" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <!-- Optional custom styles -->
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa;
        }
        h1 {
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
        }
        .random-words .badge {
            font-size: 1em;
        }
        .blank {
            display: inline-block;
            border-bottom: 2px solid #000;
            margin: 0 2px;
            vertical-align: bottom;
        }
        .highlight {
            font-weight: bold;
            background-color: #d4edda;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .btn-show-answers {
            margin-top: 10px;
        }
        .main-text {
            font-size: 1.1em;
            line-height: 1.6;
        }
    </style>
    <!-- Load the sentences.js file -->
    <script src="sentences.js"></script>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center">Fill in the Blanks Exercise</h1>
        <div class="card mb-4">
            <div class="card-body">
                <div class="random-words text-center mb-3">
                    <span class="fw-bold">Random Words:</span>
                    <span id="random-words-display"></span>
                </div>
                <div class="text-center">
                    <button class="btn btn-primary btn-show-answers">Show Correct Answers</button>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="card-body">
                <div class="main-text">
                    <!-- Main text will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript code -->
    <script>
        const NUM_RANDOM_WORDS = 5;

        // Simple function to get URL parameter
        const sentenceKey = new URLSearchParams(window.location.search).get('sentenceKey');

        // Function to get the sentence array based on the 'sentenceKey' parameter
        function getSentenceArray() {
            if (sentenceKey && sentencesRegistry[sentenceKey]) {
                return sentencesRegistry[sentenceKey];
            } else {
                console.error('Invalid sentenceKey or not found in registry.');
                return [];
            }
        }

        function getSecureRandomNumber() {
            const array = new Uint32Array(1);
            window.crypto.getRandomValues(array);
            return array[0] / (0xFFFFFFFF + 1);
        }

        const articles = ['a', 'an', 'the'];
        const pronouns = ['i', 'you', 'he', 'she', 'it', 'we', 'they', 'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'hers', 'its', 'our', 'their', 'mine', 'yours', 'hers', 'ours', 'theirs', 'this', 'that', 'these', 'those'];
        const prepositions = ['of', 'to', 'in', 'for', 'on', 'with', 'at', 'by', 'from', 'up', 'about', 'into', 'over', 'after', 'beneath', 'under', 'above', 'across', 'against', 'among', 'around', 'before', 'behind', 'below', 'beside', 'between', 'beyond', 'but', 'during', 'except', 'inside', 'near', 'off', 'through', 'toward', 'upon', 'within', 'without'];

        const conjunctions = ['and', 'but', 'or', 'nor', 'for', 'yet', 'so', 'if', 'although', 'because', 'since', 'unless', 'while'];
        const commonAdverbs = ['very', 'really', 'extremely', 'almost', 'nearly', 'quite', 'just', 'simply', 'actually'];
        const auxiliaryVerbs = ['am', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had', 'do', 'does', 'did', 'will', 'shall', 'would', 'should', 'can', 'could', 'may', 'might', 'must', 'ought'];
        const interjections = ['oh', 'ah', 'well', 'hey', 'wow', 'oops', 'ugh', 'uh', 'um', 'hmm'];

        const stopWords = articles
            .concat(pronouns)
            .concat(prepositions)
            .concat(conjunctions)
            .concat(commonAdverbs)
            .concat(auxiliaryVerbs)
            .concat(interjections);

        let selectedWords = [];
        let modifiedText = '';
        let tokens = [];
        let wordsToRestore = {};

        window.onload = function() {
            const sentencesArray = getSentenceArray();

            if (sentencesArray.length === 0) {
                document.querySelector('.main-text').innerHTML = 'No valid sentence set found. Please check the sentenceKey.';
                return;
            }

            const MAIN_TEXT = sentencesArray[Math.floor(getSecureRandomNumber() * sentencesArray.length)];

            // Simplify the logic to sanitize the text
            let sanitizedText = MAIN_TEXT.replace(/[^a-zA-Z\s]/g, '_');

            // Split into tokens (words, underscores, and spaces)
            tokens = sanitizedText.match(/\w+|_+|\s+/g);

            let candidateWords = [];

            // Identify candidate words and their positions
            for (let i = 0; i < tokens.length; i++) {
                let token = tokens[i];
                if (/^[a-zA-Z]+$/.test(token)) { // If token is a word
                    if (!/\d/.test(token)) { // Exclude words with numbers
                        let wordLower = token.toLowerCase();
                        if (stopWords.indexOf(wordLower) === -1) { // Not a stop word
                            candidateWords.push({ word: token, index: i });
                        }
                    }
                }
            }

            // Shuffle candidate words
            shuffle(candidateWords);

            // Select NUM_RANDOM_WORDS words
            selectedWords = candidateWords.slice(0, NUM_RANDOM_WORDS);

            // Keep track of words to restore
            selectedWords.forEach(function(item) {
                wordsToRestore[item.index] = item.word;
                // Replace selected words with blanks in tokens
                var wordLength = item.word.length;
                tokens[item.index] = '<span class="blank" data-index="' + item.index + '" style="width:' + wordLength + 'ch;"></span>';
            });

            // Create modified text
            modifiedText = tokens.join('');

            // Shuffle words for display
            let displayWords = selectedWords.map(item => item.word);
            shuffle(displayWords);

            // Display the random words at the top
            let randomWordsDisplay = '';
            displayWords.forEach(function(word) {
                randomWordsDisplay += '<span class="badge bg-secondary mx-1">' + word + '</span>';
            });
            document.querySelector('#random-words-display').innerHTML = randomWordsDisplay;

            // Display the modified text
            document.querySelector('.main-text').innerHTML = modifiedText;

            // Set up the event listener for the button
            document.querySelector('.btn-show-answers').addEventListener('click', function() {
                document.querySelectorAll('.blank').forEach(function(elem) {
                    const index = elem.getAttribute('data-index');
                    elem.classList.remove('blank');
                    elem.classList.add('highlight');
                    elem.style.width = 'auto';
                    elem.textContent = wordsToRestore[index];
                });
            });
        };

        function shuffle(array) {
            // Durstenfeld shuffle algorithm
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(getSecureRandomNumber() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-ApNrmAKGpwrJciqUy+JrrnUMy3HRXwKAdlrH6Cvk1cPZAbdKAY5B+i7W0bNPp/Qh" crossorigin="anonymous"></script>
</body>
</html>
